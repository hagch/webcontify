drop table if exists WEBCONTIFY_QUERY_RELATION CASCADE;
drop table if exists WEBCONTIFY_QUERY CASCADE;
drop table if exists WEBCONTIFY_COLLECTION_RELATION_COLLECTION_FIELD CASCADE;
drop table if exists WEBCONTIFY_COLLECTION_RELATION CASCADE;
drop type if exists WEBCONTIFY_COLLECTION_RELATION_TYPE CASCADE;
drop table if exists WEBCONTIFY_COLLECTION CASCADE;
drop table if exists WEBCONTIFY_COLLECTION_FIELD CASCADE;
drop type if exists WEBCONTIFY_COLLECTION_FIELD_TYPE CASCADE;
drop type if exists WEBCONTIFY_QUERY_AGGREGATION_TYPE CASCADE;

-- TODO DisplayName should be unique
create table WEBCONTIFY_COLLECTION(
    ID BIGINT PRIMARY KEY GENERATED ALWAYS AS IDENTITY,
    NAME TEXT NOT NULL,
    DISPLAY_NAME TEXT NOT NULL,
    CONSTRAINT COLLECTION_NAME_UNIQUE UNIQUE (NAME)
);

create type WEBCONTIFY_COLLECTION_FIELD_TYPE as enum (
    'NUMBER',
    'DECIMAL',
    'TEXT',
    'TIMESTAMP',
    'BOOLEAN',
    'UUID'
);
-- TODO DisplayName should be unique
create table WEBCONTIFY_COLLECTION_FIELD
(
    ID BIGINT PRIMARY KEY GENERATED ALWAYS AS IDENTITY,
    COLLECTION_ID BIGINT REFERENCES WEBCONTIFY_COLLECTION(ID) ON DELETE CASCADE,
    NAME TEXT NOT NULL,
    DISPLAY_NAME TEXT NOT NULL,
    TYPE WEBCONTIFY_COLLECTION_FIELD_TYPE NOT NULL,
    IS_PRIMARY_KEY BOOLEAN NOT NULL,
    CONFIGURATION JSONB,
    CONSTRAINT COLLECTION_FIELD_UNIQUE UNIQUE (COLLECTION_ID,NAME)
);

create type WEBCONTIFY_COLLECTION_RELATION_TYPE as enum (
    'ONE_TO_ONE',
    'ONE_TO_MANY',
    'MANY_TO_MANY',
    'MANY_TO_ONE'
);
-- many to any and any to any?
create table WEBCONTIFY_COLLECTION_RELATION(
    ID BIGINT PRIMARY KEY GENERATED ALWAYS AS IDENTITY,
    SOURCE_COLLECTION_ID BIGINT REFERENCES WEBCONTIFY_COLLECTION(ID) ON DELETE CASCADE NOT NULL,
    SOURCE_RELATION_NAME TEXT NOT NULL,
    MAPPING_COLLECTION_ID BIGINT REFERENCES WEBCONTIFY_COLLECTION(ID) ON DELETE CASCADE,
    MAPPING_RELATION_NAME TEXT,
    REFERENCED_COLLECTION_ID BIGINT NOT NULL REFERENCES WEBCONTIFY_COLLECTION(ID) ON DELETE CASCADE NOT NULL,
    REFERENCED_RELATION_NAME TEXT NOT NULL,
    TYPE WEBCONTIFY_COLLECTION_RELATION_TYPE NOT NULL,
    CONSTRAINT COLLECTION_RELATION_SOURCE_NAME_UNIQUE UNIQUE (SOURCE_COLLECTION_ID,SOURCE_RELATION_NAME,MAPPING_COLLECTION_ID,REFERENCED_COLLECTION_ID),
    CONSTRAINT COLLECTION_RELATION_MAPPING_NAME_UNIQUE UNIQUE (SOURCE_COLLECTION_ID,MAPPING_RELATION_NAME,MAPPING_COLLECTION_ID,REFERENCED_COLLECTION_ID),
    CONSTRAINT COLLECTION_RELATION_REFERENCED_NAME_UNIQUE UNIQUE (SOURCE_COLLECTION_ID,REFERENCED_RELATION_NAME,MAPPING_COLLECTION_ID,REFERENCED_COLLECTION_ID)
);

create table WEBCONTIFY_COLLECTION_RELATION_FIELD(
    RELATION_ID BIGINT REFERENCES WEBCONTIFY_COLLECTION_RELATION(ID) ON DELETE CASCADE,
    SOURCE_FIELD_ID BIGINT REFERENCES WEBCONTIFY_COLLECTION_FIELD(ID) NOT NULL,
    REFERENCED_FIELD_ID BIGINT REFERENCES WEBCONTIFY_COLLECTION_FIELD(ID),
    PRIMARY KEY (RELATION_ID,SOURCE_FIELD_ID,REFERENCED_FIELD_ID)
);


create table WEBCONTIFY_QUERY
(
                                ID BIGINT PRIMARY KEY GENERATED BY DEFAULT AS IDENTITY,
                                NAME TEXT NOT NULL,
                                DISPLAY_NAME TEXT NOT NULL,
                                SOURCE_COLLECTION_ID BIGINT NOT NULL REFERENCES WEBCONTIFY_COLLECTION(ID) ON DELETE CASCADE
);

create type WEBCONTIFY_QUERY_AGGREGATION_TYPE as enum (
    'OBJECT',
    'LIST'
);

create table WEBCONTIFY_QUERY_RELATION(
                                         ID BIGINT PRIMARY KEY GENERATED BY DEFAULT AS IDENTITY,
                                         VIEW_ID BIGINT REFERENCES WEBCONTIFY_QUERY(ID) ON DELETE CASCADE,
                                         COLLECTION_ID BIGINT REFERENCES WEBCONTIFY_COLLECTION(ID) ON DELETE CASCADE,
                                         RELATION_ID BIGINT REFERENCES WEBCONTIFY_COLLECTION_RELATION(ID) ON DELETE CASCADE,
                                         AGGREGATION_TYPE WEBCONTIFY_QUERY_AGGREGATION_TYPE NOT NULL,
                                         MANDATORY BOOLEAN NOT NULL,
                                         VIEW_RELATION_PARENT_ID BIGINT,
                                         CONSTRAINT FK_PARENT_VIEW_RELATION FOREIGN KEY(VIEW_RELATION_PARENT_ID) REFERENCES WEBCONTIFY_QUERY_RELATION(ID) ON DELETE CASCADE
);