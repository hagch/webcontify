drop table if exists WEBCONTIFY_COLLECTION_RELATION_COLLECTION_FIELD CASCADE;
drop table if exists WEBCONTIFY_COLLECTION_RELATION CASCADE;
drop type if exists WEBCONTIFY_COLLECTION_RELATION_TYPE CASCADE;
drop table if exists WEBCONTIFY_COLLECTION CASCADE;
drop table if exists WEBCONTIFY_COLLECTION_FIELD CASCADE;
drop type if exists WEBCONTIFY_COLLECTION_FIELD_TYPE CASCADE;

create table WEBCONTIFY_COLLECTION(
    ID BIGINT PRIMARY KEY GENERATED BY DEFAULT AS IDENTITY,
    NAME TEXT NOT NULL,
    DISPLAY_NAME TEXT NOT NULL,
    CONSTRAINT COLLECTION_NAME_UNIQUE UNIQUE (NAME)
);

create type WEBCONTIFY_COLLECTION_FIELD_TYPE as enum (
    'NUMBER',
    'DECIMAL',
    'TEXT',
    'TIMESTAMP',
    'BOOLEAN',
    'UUID',
    'RELATION_MIRROR'
);

create table WEBCONTIFY_COLLECTION_FIELD(
    ID BIGINT PRIMARY KEY GENERATED BY DEFAULT AS IDENTITY,
    COLLECTION_ID BIGINT REFERENCES WEBCONTIFY_COLLECTION(ID) ON DELETE CASCADE,
    NAME TEXT NOT NULL,
    DISPLAY_NAME TEXT NOT NULL,
    TYPE WEBCONTIFY_COLLECTION_FIELD_TYPE NOT NULL,
    IS_PRIMARY_KEY BOOLEAN NOT NULL,
    CONFIGURATION JSONB,
    CONSTRAINT COLLECTION_FIELD_UNIQUE UNIQUE (COLLECTION_ID,NAME)
);

create type WEBCONTIFY_COLLECTION_RELATION_TYPE as enum (
    'ONE_TO_ONE',
    'ONE_TO_MANY',
    'MANY_TO_MANY',
    'MANY_TO_ONE'
);
-- many to any and any to any?
create table WEBCONTIFY_COLLECTION_RELATION(
    ID BIGINT PRIMARY KEY GENERATED BY DEFAULT AS IDENTITY,
    SOURCE_COLLECTION_ID BIGINT REFERENCES WEBCONTIFY_COLLECTION(ID) ON DELETE CASCADE,
    MAPPING_COLLECTION_ID BIGINT REFERENCES WEBCONTIFY_COLLECTION(ID) ON DELETE CASCADE,
    REFERENCED_COLLECTION_ID BIGINT NOT NULL REFERENCES WEBCONTIFY_COLLECTION(ID) ON DELETE CASCADE,
    TYPE WEBCONTIFY_COLLECTION_RELATION_TYPE NOT NULL
);

create table WEBCONTIFY_COLLECTION_RELATION_FIELD(
    RELATION_ID BIGINT REFERENCES WEBCONTIFY_COLLECTION_RELATION(ID) ON DELETE CASCADE,
    SOURCE_FIELD_ID BIGINT REFERENCES WEBCONTIFY_COLLECTION_FIELD(ID) NOT NULL,
    REFERENCED_FIELD_ID BIGINT REFERENCES WEBCONTIFY_COLLECTION_FIELD(ID) NOT NULL,
    PRIMARY KEY (RELATION_ID,SOURCE_FIELD_ID,REFERENCED_FIELD_ID)
);
